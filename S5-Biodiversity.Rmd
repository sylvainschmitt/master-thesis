---
title: "Supplementary material S5: Biodiversity effect results"
date: '`r Sys.Date()`'
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::pdf_document2:
    number_sections: false
    toc: false
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()); invisible(gc())
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(broom)
theme_set(bayesplot::theme_default())
opts_chunk$set( echo = F, message = F, warning = F, 
                fig.height = 8, fig.width = 12,
                cache = T, cache.lazy = F)
```

```{r BE, echo=FALSE}
rich <- c(5,25,125)
cvh <- 1:20
dist <- c(0,25,50,75)
path <- '~/Documents/ECOFOG/Results/disturbance/disturbance/data'
load(file.path(path, 'disturbanceDOE.Rdata'))
doe <- rename(doe, SR = richness)
load(file.path(path, 'disturbanceData.Rdata'))
load(file.path(path, 'disturbanceBE.Rdata'))
load(file.path(path, 'disturbanceBErecovery.Rdata'))
load(file.path(path, '../../maturity', 'matureBE.Rdata'))
load(file.path(path, '../../maturity', 'matureData.Rdata'))
mature <- datal$time ; rm(datal)
```

This document explore graphically the result of the biodiversity net effect partitionning. More especially we want to look if the representation from figure \@ref(fig:gBE) is correct, with the dynamic biodiversity net effect normalized by the control across ecosystems. In order to do that we will start by looking into the dynamic of a single ecosystem \@ref(fig:gBEsingle), we will then move to all ecosystem not normalized by the control \@ref(fig:gBEunorm), before validating our current representation \@ref(fig:gBE).

# Single ecosystem biodiversity dynamic

The net effect of biodiversity on ecosystem recovery was partitioned between selection and complementarity effect. We are thus able for one community to look at aboveground biomass dynamic after and before disturbance in control and disturbed ecosystems and correspondig bioviersity net effect, selection effect and complementarity effect (figure \@ref(fig:gBEsingle)). Similarly to global aboveground biomass from the ecosystem the biodiversity net effect and selection effect decrease following the disturbance, whereas the complementarity effect directly increase following the disturbance. Interestingly, we can see that this pattern of decrease of selection effect after disturbance and recovery after is similar to the effect of succession in forest early stages (first century, sub-figure on left-bottom on figure \@ref(fig:gBEsingle)).


```{r gBEsingle, fig.cap='Dynamic of complementarity and selection effects before and after the disturbance event for one ecosystem including 125 species. Solid lines represents the mean value whereas areas represents the interval of values among simulations.'}
g <- BE %>% 
  select(sim, BE, time, agb) %>% 
  separate(sim, c("SR", "CHV", "disturbance"), remove = F) %>% 
  rbind(ecosystem %>% 
          mutate(BE = "ecosystem") %>%
          select(sim, BE, time, agb) %>% 
          separate(sim, c("SR", "CHV", "disturbance"), remove = F)) %>% 
  rbind(BE_mature %>% 
          mutate(time = time - 600) %>% 
          select(sim, BE, time, agb) %>% 
          separate(sim, c("SR", "CHV"), remove = F) %>% 
          mutate(disturbance = "0-75") %>% 
          separate_rows(disturbance, sep = "-", convert = T)) %>% 
  rbind(mature %>% 
          mutate(time = time-600) %>% 
          mutate(BE = "ecosystem") %>% 
          select(sim, BE, time, agb) %>% 
          separate(sim, c("SR", "CHV"), remove = F) %>% 
          mutate(disturbance = "0-75") %>% 
          separate_rows(disturbance, sep = "-", convert = T)) %>% 
  filter(SR == 125, disturbance %in% c(0,75), CHV == 4) %>% 
  reshape2::dcast(SR + CHV + BE + time ~ disturbance, value.var = "agb") %>% 
  rename(control = `0`, disturbed = `75`) %>% 
  ggplot(aes(x = time, col = BE, group = BE)) +
  geom_line(aes(y = control, linetype = "control")) +
  geom_line(aes(y = disturbed, linetype = "disturbed")) + 
  xlab("Time (years)") + 
  ylab("Aboveground biomass (tonC/ha)") +
  scale_color_discrete("Biodiversity\neffect")
g0 <- g + 
  geom_line(aes(y = control, linetype = "control")) +
  geom_line(aes(y = disturbed, linetype = "disturbed")) + 
  geom_ribbon(aes(ymin = disturbed, ymax = control), 
              col = NA, fill = "lightgrey", alpha = 0.5)
gdist <- g + 
  geom_line(aes(y = control, linetype = "control"), lwd = 1.4) +
  geom_line(aes(y = disturbed, linetype = "disturbed"), lwd = 1.4) + 
  xlim(-10,50) + ylim(NA, 60000) +
  scale_color_discrete(guide = F) +
  scale_linetype_discrete(guide = F)
gstart <- g + 
  geom_line(aes(y = control, linetype = "control"), lwd = 1.4) +
  geom_line(aes(y = disturbed, linetype = "disturbed"), lwd = 1.4) + 
  xlim(-600,-500) + ylim(NA, 50000) +
  scale_color_discrete(guide = F) +
  scale_linetype_discrete(guide = F)
gridExtra::grid.arrange(g0, gstart, gdist, 
                        layout_matrix = rbind(c(1, 1), c(2, 3)))
```

# Non-normalized ecosystems biodiversity dynamic

If we aggregate the result of all community with 125 species, we still observe the same pattern (figure \@ref(fig:gBEunorm)). But due to an increase of biodiversity net effect through recovery time, complementarity importance in early recovery is less visible over a long period. Consequently normalizing by control biodiversity net effect can help avoiding this issue.

```{r gBEunorm, fig.cap='Dynamic of complementarity and selection effects for all ecosystems including 125 species. Solid lines represents the mean value whereas areas represents the interval of values among simulations.'}
BE %>% 
  rbind(mutate(ecosystem, BE = "ecosystem")) %>% 
  left_join(., doe, by = 'sim') %>%
  filter(SR == 125, disturbance == 75) %>% 
  group_by(time, BE, disturbance, SR) %>%
  summarise(qt1 =quantile(agb, probs=0.05),
            qt2 =quantile(agb, probs=0.75),
            mean=mean(agb),
            n=n()) %>% 
  ggplot(aes(x = time)) +
  geom_ribbon(aes(ymin = qt1, ymax = qt2, fill = BE), alpha = 0.3) +
  geom_line(aes(y = mean, color = BE)) +
  xlab('Time (years)') +
  ylab('Aboveground biomass net effect')
```


# Normalized ecosystems biodiversity dynamic

The net effect of biodiversity on ecosystem recovery was partitioned between selection and complementarity effect after normalizing using undisturbed control simulation ($disturb_{intensity}=0\%$, figure \@ref(fig:gBE)). Thanks to previous graphical exploration, we can affirm that normalizing by the control is not distorting the result. And this last figure brings the clearer message regarding complementarity and selection effect role in the resilience of the biodiveristy net effect.

```{r gBE, echo=FALSE, fig.cap='Recovery of complementarity and selection effects. Complementarity effect (CE) and selection effect (SE) where normalized by control net effect (NEc), thus measuring their recovery over time. Solid lines represents the mean value whereas areas represents the interval of values among simulations.', cache=TRUE}
BEresilience %>% 
  left_join(., doe, by = 'sim') %>%
  filter(SR == 125) %>% 
  # filter(BE %in% c('SE', 'CE')) %>%
  group_by(time, BE, disturbance, SR) %>%
  summarise(qt1 =quantile(agb, probs=0.05),
            qt2 =quantile(agb, probs=0.75),
            mean=mean(agb),
            n=n()) %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 1, color = 'red') +
  geom_hline(yintercept = 0, color = 'blue') +
  geom_ribbon(aes(ymin = qt1, ymax = qt2, fill = BE), alpha = 0.3) +
  geom_line(aes(y = mean, color = BE)) +
  facet_grid(disturbance ~ SR, labeller = 'label_both') +
  xlab('Time (years)') +
  ylab('Recovery of aboveground biomass net effect')
```

