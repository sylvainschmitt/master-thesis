# Appendix 2: Leaf lifespan model

TROLL model previous implementation encompass Reich's 1991 and 1997 and Wright's 2004 allometries to estimate leaf lifespan with  [@Reich1991a; @Reich1997; @wright_worldwide_2004]. But we have shown that Reich's allometries are underestimating leaf lifespan for low LMA species. Moreover simulations estimated unrealistically low aboveground biomass for low LMA species. We assumed Reich's allometries underestimation of leaf lifespan for low LMA species being the source of unrealistically low aboveground biomass inside TROLL simulations. We decided to find a better allometry with @wright_worldwide_2004 GLOPNET dataset.

## Material and methods

We gathered data from TRY database to evaluate and improve previous models. We requested functional traits available in Bridge dataset and leaf lifespan for tropical species present in GLOPNET dataset and used in TROLL (see \@ref(tab:A2traits)). We compiled GLOPNET, TRY, and DRYAD databases. We kept dataset given by GLOPNET as origin dataset for observations. It correspond to leaf lifespan and also to LMA and Nmass in most of cases. We measured variable importance in functionnal traits to explain leaf lifespan with out-of bag method applied on a random forest.

```{r A2traits, echo=FALSE}
knitr::kable(data.frame(
  Name = c('LL', 'SLA', 'N', 'P', 'wsg'),
  Trait = c('Leaf lifespan (longevity)',
            'Leaf area per leaf dry mass (specific leaf area, SLA)',
            'Leaf nitrogen (N) content per leaf dry mass',
            'Leaf phosphorus (P) content per leaf dry mass',
            'Stem dry mass per stem fresh volume (stem specific density)'),
  Unit = c('month',' $m^2.kg^{-1}$', '$mg.g^{-1}$', '$mg.g^{-1}$', '$mg.mm^{-3}$'),
  TRYcode = c(12, 11, 15, 14, 4)),
  caption = 'Functional traits gathered with TRY.')
```

```{r A2data, include=FALSE, echo=FALSE, cache=TRUE}
library(readr)
library(reshape2)
library(BIOMASS)
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/LL/GLOPNET.csv", skip = 10)
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES <- LES[-which(is.na(LES$log.LL)),]
data <- cbind(LES[c('Dataset', 'Species')],
              10^LES[paste0('log.',c('LL', 'LMA', 'Nmass', 'Narea',
                                     'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea'))])
names(data) <- c('Dataset', 'Species', 'LL', 'LMA', 'Nmass', 'Narea',
              'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea')
data <- droplevels(data[c('Dataset', 'Species', 'LL', 'LMA', 'Nmass')])
TRY <- read_delim("~/Documents/ECOFOG/TROLL/inst/extdata/LL/TRY3.txt",
    "\t", escape_double = FALSE, trim_ws = TRUE)
TRY <- data.frame(TRY[c('Dataset', 'SpeciesName', 'TraitName', 'StdValue')])
TRY <- TRY[-which(is.na(TRY$TraitName)),]
traits <- c('SLA', 'Nm', 'Pm', 'LL', 'wsg')
names(traits) <- unique(TRY$TraitName)
TRY$TraitName <- traits[TRY$TraitName] ; rm(traits)
K_TRY <- read_csv("~/Documents/ECOFOG/TROLL/inst/extdata/LL/Kitajima.csv")
K_TRY <- data.frame(K_TRY[c('Species', 'Leaf lifespan (months)', 'LMA (g mâˆ’2)')])
names(K_TRY) <- c('SpeciesName', 'LL', 'SLA')
K_TRY$SLA <- (1/K_TRY$SLA)*1000
K_TRY <- melt(K_TRY, id.var = c('SpeciesName'))
names(K_TRY) <- c('SpeciesName', 'TraitName', 'StdValue')
Dataset <- rep('Kitajima', dim(K_TRY)[1])
K_TRY <- cbind(Dataset, K_TRY) ; rm(Dataset)
TRY <- rbind(TRY, K_TRY) ; rm(K_TRY)
TRY <- dcast(TRY, Dataset + SpeciesName ~ TraitName,
               value.var = 'StdValue', fun.aggregate = mean, na.rm = T)
TRY <- TRY[which(!is.na(TRY$LL)),]
TRY <- TRY[c('Dataset', 'SpeciesName', 'LL', 'SLA', 'Nm', 'wsg')]
names(TRY) <- c('Dataset', 'Species', 'LL', 'LMA', 'Nm', 'wsg')
TRY$LMA <- 1/TRY$LMA*1000
TRY$Nm <- TRY$Nm/10
TRY$LMA2 <- data$LMA[match(TRY$Species, data$Species)]
TRY$Nm2 <- data$Nmass[match(TRY$Species, data$Species)]
TRY$wsg2 <- apply(do.call('rbind', strsplit(TRY$Species, ' ', fixed = T)),
                   1, function(x) getWoodDensity(x[1],
                                                 x[2], region = 'SouthAmericaTrop')$meanWD)
TRY$LMA <- apply(TRY[c('LMA', 'LMA2')], 1, mean, na.rm = T)
TRY$Nm <- apply(TRY[c('Nm', 'Nm2')], 1, mean, na.rm = T)
TRY$wsg <- apply(TRY[c('wsg', 'wsg2')], 1, mean, na.rm = T)
data <- TRY[c("Dataset", "Species", "LL", "LMA", "Nm", "wsg")] ; rm(TRY)
na <- c(which(is.na(data$LMA)), which(is.na(data$Nm)), which(is.na(data$wsg)))
data <- data[-na,]; rm(na)
LMAmax <- max(data$LMA) ; Nmax <- max(data$Nm) ; wsgmax <- max(data$wsg)
data$Dataset <- as.factor(data$Dataset)
```

```{r functions, echo=FALSE}
fitgraph <- function(fit){
  pars <- fit@model_pars
  beta <- pars[grep('beta', pars)]
  beta <- beta[-grep('s', beta)]
  sigma <- pars[grep('sigma', pars)]
  posterior <- as.matrix(fit)
  r <- mcmc_areas(posterior,  pars = c(beta, sigma, 'lp__'), prob = 0.8)
  c <- mcmc_trace(posterior,  pars = c(beta, sigma, 'lp__'), n_warmup = 2000,
                   facet_args = list(nrow = 2, labeller = label_parsed))
  p <- ggpairs(data.frame(posterior[,beta]))
  return(list(r = r, c = c, p = p))
}
datasub <- function(data, dataset, wsg = TRUE){
  LMAmax <- max(data$LMA)
  Nmax <- max(data$Nm)
  if(wsg)
    wsgmax <- max(data$wsg)
  if(dataset != 'full')
    data <- data[-which(data$Dataset %in% dataset),]
  mdata <- list(S = length(levels(droplevels(data$Dataset))), 
              N = length(as.numeric(droplevels(data$Dataset))),
              J = as.numeric(droplevels(data$Dataset)),
              LL = data$LL,
              LMA = (data$LMA/LMAmax),
              Nmass = (data$Nm/Nmax))
  if(wsg)
    mdata$wsg <- data$wsg/wsgmax
  return(mdata)
}
```

We tested different models and we kept the model with the best tradeoff between model complexity, convergence, likelihood, and prediction quality (see [leaf lifespan model](LL2.html) document). We found following model, named **M1**:
$$M1~~ {LL_s}_j \sim \mathcal{logN}(\beta_0*e^{{\beta_1}_s*{LMA_s}_j - {\beta_2}_s*{Nmass_s}_j},\,\sigma)\,$$
$$s=1,...,S_{=4}~, ~~j=1,...,n_s$$
$${\beta_i}_s \sim \mathcal{N}({\beta_i},\,\sigma_i)\,^I, ~~(\beta_i, \sigma, \sigma_i) \sim \mathcal{\Gamma}(0.001,\,0.001)\,^{2I+1}$$

Leaf lifespan ($LL$) is following a lognormal law with location ${\mu_s}_j$ and scale $\sigma$. $s$ represents the dataset used to do the fit between 1 and $S=4$, it encompass environmental and protocol variations. $j$ represents the observation for a given site $s$. Location ${\mu_s}_j$ is the exponential from the difference between LMA and Nmass with parameters ${\beta_0}_s$, ${\beta_1}_s$, and ${\beta_2}_s$. Each ${\beta_i}_s$ is following a normal law located on $\beta_i$ with scale $\sigma_i$. Finally all $beta_i$, $\sigma$, and $\sigma_i$ are assumed without presemption following gamma laws of parameters $10^-2$, $10^-2$.

We decided to add to model **M1**, wood specific gravity as a new predictor through a parameter $\beta_3$ in a new model named **M10**. We removed dataset random effect on $\beta_3$ due to the fact that all wood specific gravities were provided by DRYAD database. Due to a correlation between $\beta_0$ and $\beta_3$ in **M10** (see figure 5), we tried also a model **M11** without intercept $\beta_0$. We then sampled all models with this composite dataset, and obtained following results :

## Results

```{r OOB, echo=FALSE}
knitr::kable(randomForest::randomForest(LL ~ LMA + Nm + LMA + wsg,
                   data = data, na.action = na.omit,
                   ntree = 1000, replace = F , importance = T,
                   do.trace = F, keep.forest = T, keep.inbag = T)$importance,
             caption = 'Variable importance calculated with out-of the bag method applied on a random forest. Leaf lifespan (LL) is taken in GLOPNET database from @wright_worldwide_2004. Leaf mass per area (LMA), and leaf nitrogen content (Nmass) are taken both in TRY (https://www.try-db.org) and GLOPNET databases. Wood specific gravity (wsg) is taken both in TRY and DRYAD databases.', format = 'pandoc')
```


Table 3: Model fit results for composite dataset. *Data are taken from GLOPNET, TRY, and DRYAD datasets (see previous description). ML stand for maximum likelihood and RMSEP for root mean square error of prediction*

```{r model, echo=FALSE}
# mdata <- sapply(c('full', levels(droplevels(data$Dataset))),
#                 function(x) datasub(data, x), simplify = F)
# fits <- lapply(as.list(paste0('M', c(1, 10, 11))), function(model){
#   fit <- lapply(mdata, function(x) stan(file = file.path(mpath, paste0(model, '.stan')), data = x))
#   eval <- NA
#   fit <- list(full = fit$full, eval = eval)
#   path <- file.path(mpath, paste0(model, '.LL.Rdata'))
#   save(fit, file = path)
# })
# fits <- list()
# i <- 1
# models <- list.files(path = mpath, pattern = '.LL.Rdata')
# for(file in models){
#   load(file = file.path(mpath, file))
#   fits[[i]] <- fit ; rm(fit) ; i <- i + 1
# }
# names(fits) <- paste0('fit', c(10, 11, 1))
# g10 <- fitgraph(fits$fit10$full)
# g11 <- fitgraph(fits$fit11$full) ; rm(file, i, models, mpath)
# tab <- data.frame(
#   M = c('M1', 'M10', 'M11'),
#   Model = c('${LL_s}_j \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*{LMA_s}_j - {\\beta_2}_s*{Nmass_s}_j,\\,\\sigma)\\,$',
#             '${LL_s}_j \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*{LMA_s}_j - {\\beta_2}_s*{Nmass_s}_j + {\\beta_3}*{wsg}_j,\\,\\sigma)\\,$',
#             '${LL_s}_j \\sim \\mathcal{logN}({\\beta_1}_s*{LMA_s}_j - {\\beta_2}_s*{Nmass_s}_j + {\\beta_3}*{wsg}_j,\\,\\sigma)\\,$'),
#   ML = c( max(as.matrix(fits$fit1$full)[,'lp__']),
#           max(as.matrix(fits$fit10$full)[,'lp__']),
#           max(as.matrix(fits$fit11$full)[,'lp__']))
# )
# kable(tab)
```

All model have correctly converged.

```{r A2r, echo=FALSE, fig.cap='Parameters posterior ditribution. Light blue area represents 80% confidence interval, and vertical blue line the mean.'}
# g11$r
```

```{r A2c, echo=FALSE, fig.cap='Parameters markov chains. Light grey area represents warmup iterations.'}
# g11$c
```

Model **M10** have shown a correlation between parameters $\beta_0$ and $\beta_3$, responsible for the creation of model **M11** (see previous paragraphs). Model **M11** only show a slight link between $\beta_1$ and $\beta_3$ which can be considered as non significant.

```{r A2p11, echo=FALSE, fig.cap='Parameters pairs plot for model M11. Parameters density distribution, pairs plot and Pearson s coefficient of correlation.'}
# g11$p + ggtitle('M11') 
```

We can denote that retained vector of parameters with maximum likelihood for model **M11** is close to 95% confidence limit.

```{r A2graph11, echo=FALSE, fig.cap='Leaflifespan predictions for model M11 with leaf mass per area (LMA), leaf nitrogen content (Nmass), wood specific gravity (wsg) and predicted versus observed values. Leaf lifespan (LL) is predicted with model M10 fit. Leaf mass per area (LMA) and leaf nitrogen content (Nmass), and wood specific gravity (wsg) are taken in a composite dataset of GLOPNET, TRY and DRYAD  datasets.Warning LMA (resp. Nmass and wsg) is not constant and depend on the closest point value for right (resp. center and left) graph.'}
# beta <- as.matrix(fits$fit11$full)[which.max(as.matrix(fits$fit11$full)[,'lp__']),c('beta_1', 'beta_2', 'beta_3')]
# fit <- fits$fit10$full
# pred <- apply(as.matrix(fit), 1, function(x)
#   sapply(seq_len(dim(data)[1]), function(i)
#       rlnorm(1, x['beta_1']*(data$LMA[i]/LMAmax) - x['beta_2']*(data$Nm[i]/Nmax) + x['beta_3']*(data$wsg[i]/wsgmax), x['sigma'])
#     ))
# pred <- data.frame(t(apply(pred, 1, function(x) quantile(x, probs = c(0.15, 0.85)))))
# names(pred) <- c('5%', '95%')
# pred$mean <- exp((beta[1]*(data$LMA/LMAmax) - beta[2]*(data$Nm/Nmax) + beta[3]*(data$wsg/wsgmax)))
# pred$LMA <- data$LMA
# pred$Nm <- data$Nm
# pred$wsg <- data$wsg
# pred$obs <- data$LL
# lma <- ggplot(data, aes(x = LMA, y = LL)) +
#   geom_ribbon(aes(x = pred$LMA, ymin = pred$`5%`, ymax = pred$`95%`), color = 'grey', alpha = 0.2) +
#   geom_line(aes(x = pred$LMA, y = pred$`5%`, color = '5%'), linetype = 2) +
#   geom_line(aes(x = pred$LMA, y = pred$`95%`, color = '95%'), linetype = 2) +
#   geom_line(aes(x = pred$LMA, y = pred$mean, color = 'mean'), linetype = 2) +
#   geom_point() +
#   theme_bw() +
#   xlab('Leaf mass per area (LMA in g/m2)') +
#   ylab('Leaf lifespan (LL in months)') +
#   scale_color_manual(name = 'Model',
#                      values = c('5%' = 'black',
#                                 '95%' = 'black',
#                                 'mean' = 'red'))
# nm <- ggplot(data, aes(x = Nm, y = LL)) +
#   geom_ribbon(aes(x = pred$Nm, ymin = pred$`5%`, ymax = pred$`95%`), color = 'grey', alpha = 0.2) +
#   geom_line(aes(x = pred$Nm, y = pred$`5%`, color = '5%'), linetype = 2) +
#   geom_line(aes(x = pred$Nm, y = pred$`95%`, color = '95%'), linetype = 2) +
#   geom_line(aes(x = pred$Nm, y = pred$mean, color = 'mean'), linetype = 2) +
#   geom_point() +
#   theme_bw() +
#   xlab('Leaf nitrogen content (Nmass in %)') +
#   ylab('Leaf lifespan (LL in months)') +
#   scale_color_manual(name = 'Model',
#                      values = c('5%' = 'black',
#                                 '95%' = 'black',
#                                 'mean' = 'red'))
# wsg<- ggplot(data, aes(x = wsg, y = LL)) +
#   geom_ribbon(aes(x = pred$wsg, ymin = pred$`5%`, ymax = pred$`95%`), color = 'grey', alpha = 0.2) +
#   geom_line(aes(x = pred$wsg, y = pred$`5%`, color = '5%'), linetype = 2) +
#   geom_line(aes(x = pred$wsg, y = pred$`95%`, color = '95%'), linetype = 2) +
#   geom_line(aes(x = pred$wsg, y = pred$mean, color = 'mean'), linetype = 2) +
#   geom_point() +
#   theme_bw() +
#   xlab('Leaf nitrogen content (Nmass in %)') +
#   ylab('Leaf lifespan (LL in months)') +
#   scale_color_manual(name = 'Model',
#                      values = c('5%' = 'black',
#                                 '95%' = 'black',
#                                 'mean' = 'red'))
# predvsobs<- ggplot(pred, aes(x = obs, y = mean)) +
#   geom_ribbon(aes(ymin =`5%`, ymax = `95%`), color = 'grey', alpha = 0.2) +
#   geom_line(aes(y = `5%`, color = '5%'), linetype = 2) +
#   geom_line(aes(y = `95%`, color = '95%'), linetype = 2) +
#   geom_line(aes(y = mean, color = 'mean'), linetype = 2) +
#   geom_point() +
#   theme_bw() +
#   xlab('Observed leaf lifespan (LL in months)') + 
#   ylab('Predicted leaf lifespan (LL in months)') +
#   geom_abline(slope = 1) +
#   scale_color_manual(name = 'Model',
#                      values = c('5%' = 'black',
#                                 '95%' = 'black',
#                                 'mean' = 'red'))
# plot_grid(lma, nm, wsg, predvsobs, labels = c('LMA', 'Nmass', 'wsg', 'P v. O'))
```

We finally tested the new allometry obtained with the new model **M** on TROLL data (figure 7) and with TROLL simulations. Minimum leaf lifespan is now above 3 months for the new model **M** with TROLL species dataset. Moreover lowest leaf lifespan species are not the one with the smallest LMA with new model. Lastly, new model **M** variation of leaf lifespan is almost spanning all previous allometries prediciton on LMA axis.

```{r TROLL, echo=FALSE, fig.cap='Leaflifespan predictions for model different allometries with leaf mass per area (LMA), and leaf nitrogen content (Nmass), and wood specific gravity (wsg). Leaf lifespan (LL) is predicted with model M1, M10, and M11 fits or Reich s and Wright s allometries [@Reich1991a]. Leaf mass per area (LMA) leaf nitrogen content (Nmass) , and wood specific gravity (wsg) are taken in BRIDGE dataset used by TROLL [@Li].'}
# species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt', header=T, dec=".", sep="", row.names = 1)[c('LMA', 'Nmass', 'wsg')]
# species$`Reich 91` <- 1.5 + 10^(7.18+3.03*log10(species$LMA*0.0001))
# species$`Reich 97` <- 10^(2.040816*(2.579713-log10(10000.0/species$LMA)))
# species$`Wright 04` <- 0.5+10^(-2.509+1.71*log10(species$LMA))
# beta <- as.matrix(fits$fit1$full)[which.max(as.matrix(fits$fit1$full)[,'lp__']),c('beta_0', 'beta_1', 'beta_2')]
# species$Model1 <- with(species, exp((beta[1] + beta[2]*(LMA/LMAmax) - beta[3]*(Nmass*100/Nmax))))
# beta <- as.matrix(fits$fit10$full)[which.max(as.matrix(fits$fit10$full)[,'lp__']),c('beta_0', 'beta_1', 'beta_2', 'beta_3')]
# species$Model10 <- with(species, exp((beta[1] + beta[2]*(LMA/LMAmax) - beta[3]*(Nmass*100/Nmax) + beta[4]*(wsg/wsgmax))))
# beta <- as.matrix(fits$fit11$full)[which.max(as.matrix(fits$fit11$full)[,'lp__']),c('beta_1', 'beta_2', 'beta_3')]
# species$Model11 <- with(species, exp((beta[1]*(LMA/LMAmax) - beta[2]*(Nmass*100/Nmax) + beta[3]*(wsg/wsgmax))))
# data <- melt(species, id = c('LMA', 'Nmass', 'wsg'))
# names(data)[4] <- 'Allometry'
# g <- ggplot(data, aes(x = LMA, y = value, color = Allometry)) +
#   geom_point() + theme_bw() +   xlab('LMA in g/m2') +
#   ylab('Leaf lifespan (LL in months)')
# h <- ggplot(data, aes(x = Nmass, y = value, color = Allometry)) +
#   geom_point() + theme_bw() +   xlab('Nmass in %') +
#   ylab('Leaf lifespan (LL in months)')
# f <- ggplot(data, aes(x = wsg, y = value, color = Allometry)) +
#   geom_point() + theme_bw() +   xlab('wsg in mg/mm3') +
#   ylab('Leaf lifespan (LL in months)')
# plot_grid(g, h, f, labels = c('LMA', 'Nmass', 'wsg'))
```

Simulations are validating that this new allometry resolve the issue of unrealistically low aboveground biomass for low LMA species due to an early edath of individuals inside simulations. For instance with this allometry Symphonia sp 1 (a low LMA species) is now reaching a realistic aboveground biomass above X tonnes of C/ha and realistic diameter and age distribution inside the final population.
