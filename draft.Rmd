---
title: Biodiversity improves tropical forest resilience
author: "Sylvain Schmitt, Isabelle Maréchaux, Jerome Chave, Fabian Fischer, Camille Piponiot, Stéphane Traissac & Bruno Hérault"
date: '`r Sys.Date()`'
output:
  bookdown::word_document2: default
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
  github_document: default
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()); invisible(gc())
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(broom)
theme_set(bayesplot::theme_default())
opts_chunk$set( echo = F, message = F, warning = F, 
                fig.height = 8, fig.width = 12,
                cache = T, cache.lazy = F)
```

```{r resilience, echo=FALSE}
rich <- c(5,25,125)
cvh <- 1:20
dist <- c(0,25,50,75)
path <- '~/Documents/ECOFOG/Results/disturbance/disturbance/data'
load(file.path(path, 'disturbanceDOE.Rdata'))
doe <- rename(doe, SR = richness)
load(file.path(path, 'disturbanceData.Rdata'))
load(file.path(path, 'disturbanceResilience.Rdata'))
```

```{r Deq, cache=TRUE, echo=FALSE}
Deq <- resilience %>% 
  group_by(time, sim) %>% 
  mutate_all(funs((1-.)^2)) %>% 
  mutate(structure = sqrt(sum(agb, ba, n, n10, n30))) %>% 
  mutate(production = sqrt(sum(gpp, npp, Rday, Rnight)))
```

```{r Ir, cache=TRUE, echo=FALSE}
Ir <- Deq %>% 
  group_by(sim) %>% 
  arrange(time) %>% 
  mutate_at(vars(-time, -sim), funs(1/cumsum(.))) %>% 
  filter(time == 600)
```

# Abstract

**To be written**

# Introduction 

Natural disturbances play a major role in tropical forest functioning through gap-phase regeneration [@Veblen1992]. Climate change and direct human activities are currently deeply modifying forest disturbance regimes [@Davidson2012; @Lewis2015] and while deforestation has been rightly the focus of worldwide attention, the consequences of human-induced disturbance on tropical forests has been less studied [@Putz2010; @Simula2009]. However, degraded forests currently cover areas over ten times larger than deforested ones [@Herold2011], a majority of which is being unsustainably logged for timber production [@Blaser2011]. Forest degradation can trigger severe biodiversity loss [@Burivalova2014] and is estimated to account for 20.7 billion of tons of carbon dioxide emissions per year [@Pearson2017], representing, for instance, 20% of greenhouse gas emissions in the Brazilian Amazon [@Asner2005].  In addition to the direct impact of human on forests, a more insidious disturbance is climate change that modifies regional climates with, for instance, projected increases in the frequency and intensity of convective storms in the Amazon having the potential to increase wind-related tree mortality [@Negron-Juarez2018]. Understanding the drivers of tropical forest resilience to disturbance is thus critical. Here we explored the role of biodiversity in tropical forest recovery after disturbance through a simulation approach.

The concept of ecological resilience has met numerous definitions, but encompass both ecosystem ability to adsorb, the resistance component, and recover from disturbance [@Gunderson2010]. Both exogenous (e.g. climate, disturbance features) and endogenous (e.g. forest structure and composition) factors can drive ecosystem recovery after disturbance. Among the former, logging intensity has been reported to strongly control and increase time-to-recovery of post-logging tree carbon, subsequent animal biodiversity loss, and change in tree species composition [@Burivalova2014; @DeAvila2015; @Rutishauser2015]. Among endogenous drivers, forest pre-disturbance composition has been identified as a key driver of forest recovery [@Herault2018], as different species respond differently to perturbations depending on their ecological strategies and functional properties [@herault_functional_2011]. Beyond species identity, tree community diversity may also foster forest resilience to perturbations [@Cadotte2011; @Ives2007; @Loreau2013]. Finally, disturbance intensity itself has been shown to be a key component of forest resilience [@DeAvila2018].

Two types of mechanisms can underlie the effect of biodiversity on ecosystem properties: complementarity and selection effects [@Loreau2001]. Complementarity effect results from resources partitioning and niche differentiation, and facilitation, leading to a more efficient use of available resources at the community level. Selection effect results from a higher probability of more diverse community to include particularly efficient species regarding ecosystem processes. Moreover the sampling effect additionally implies redundancy and a lower risk to lose important functional traits, further improving resilience of species rich-forest [@Hooper2005a; @Tilman2001].

The effect of biodiversity on ecosystem functioning has been intensely studied over the last decades, through theoretical work [@Loreau2010], experiments [@Cardinale2007; @Cardinale2009; @Niklaus2017a; @Huang2018], or direct observations along natural gradient [@Chisholm2013; @Liang2016; @Paquette2011; @Poorter2017]. Several studies advocate for the importance of few dominant species through selection effect to regulate ecosystem functioning in an old tree diversity experiment [@Bauters2015], in wet or dry natural forests [@Finegan2015; @Prado-Junior2016], or in human-modified forests [@DeAvila2018; @Lohbeck2016]. Numerous authors have, however, highlighted the pivotal role of diversity in ecosystem stability [@Morin2014a] and highlighted the role of both complementarity and selection for ecosystem biomass stock and dynamic [@Cardinale2007; @Poorter2017; @VanderSande2017a]. For instance, @Fargione2007 observed a shift from selection to complementarity effect over time in experimental grasslands, and @Huang2018 observed an increased complementarity over time with no selection effect in forest establishments experiments.

Overall, the role of biodiversity in tropical forest recovery from disturbances and the mechanisms underlying the biodiversity effect on forest functioning along long-term dynamics remain under documented [@VanderSande2017]. Experiments have mostly been conducted on grasslands [@Hector2005], while studies relying on forest stand inventories often lack repeatability [@Poorter2017; @Schnitzer2016], rarely include disturbed forests [@Sist2015], and monitoring temporal coverage remains too low to assess long-term effect as trees are long-lived organisms [@Herault2018]. Forest simulators have thus proven useful to investigate the effect of biodiversity on forest ecosystem functioning through virtual biodiversity experiments [@Morin2011; @Morin2014a; @Sakschewski2016; @Bohn2017]. However, the problem of biodiversity representation beyond a few plant functional types in models of tropical forests have long been an impediment to apply this approach to this species-rich ecosystem [@Kazmierczak2014; @Kohler1998; @Purves2008].

In the present study, we take advantage of recent developments made in the forest simulator TROLL [@Chave1999], an individual-based and spatially-explicit model of tropical forest, that allow to deal with high diversity levels through a parameterization using plant functional traits [@Marechaux2017]. Consequently, TROLL offers the opportunity to study biodiversity-ecosystem functioning  relationships *in silico* in tropical forest communities. More specifically, we used a simulation approach to assess the effect of species and functional diversity on long-term forest recovery from disturbances of different levels. We manipulated species number and identity across a large number of simulations, and measured the biodiversity net effect on simulated forest recovery after disturbance. In order to further investigate the mechanisms underlying such potential effect of biodiversity, we partitioned ecosystem properties into complementarity and selection effects. Based on the general hypothesis of a positive relationships between biodiversity and productivity [@Liang2016], we hypothesized that more diverse forest will recover quicker to a disturbance event due to an increased productivity [but see @VanderSande2018].

# Material and Methods

## TROLL Model

TROLL is an individual-based and spatially explicit forest dynamic model in which the life cycle of individual trees (recruitment, growth, seed production and death) $>1cm$ diameter at breast height (dbh) is simulated. Trees grow in a forest light environment computed within a $1m^3$ resolution voxel grid. Seedlings below the $1cm$ size class are not modeled on an individual basis, but are part of a seed/seedlings pool. A maximum of one tree can establish in each $1*1m$ pixel. Each tree is defined by its age, dbh, height (h), crown radius (CR), crown depth (CD) and leaf area (LA). Tree geometry is calculated with allometric relationships. Additionally, each tree is flagged with a species label inherited from the parent tree through the seedling recruitment. To each species label is associated a number of species-specific traits (Table \@ref(tab:traits)) from which ecophysiological processes are simulated using up-to-date established relationships drawn from the literature. The model thus represents tree biodiversity in a realistic way, where data requirement and model outputs parallel current trait collection efforts and field inventories, respectively.

Carbon assimilation is computed over half-hourly period of a representative day per month using the Farquhar, von Caemmerer, and Berry model of photosynthesis [@Farquhar1980].  Photosynthetic capacities, as well as leaf respiration rate, are computed from species-specific leaf concentration of nitrogen (N) and phosphorous (P), and leaf mass per area [LMA; @Atkin2015; @Domingues2010]. The net amount of assimilated carbon available for growth is then partitioned among the different plant organs using empirical factors, and converted into increments of stem volume and leaf area using species-specific wood-density and LMA respectively. Leaf demography is simulated using species-specific leaf lifespan derived from LMA. Following an underestimation of leaf lifespan for low LMA species, we designed our own leaf lifespan allometry, specific to tropical tree species, to be used in subsequent analysis (see supplementary materials S1). Natural tree deaths are stochastic events whose background rate is negatively correlated with wood density, as observed pan-tropically [@kraft_functional_2010; @poorter_are_2008; @Wright2010] an locally [@Aubry-Kientz2013]. Additionally, tree can die due to carbon starvation or treefalls. Below-ground processes, herbaceous plants, epiphytes and lianas are not simulated in this version of TROLL. The source code is written in C++ and available at https://github.com/TROLL-code/TROLL. A further detailed description of the model is available in @Marechaux2017.

```{r traits, echo=FALSE}
table <- data.frame(
  Abbreviation = c('$LMA$', '$N_m$', '$P_m$', '$wsg$', '$dbh_{thresh}$', '$h_{lim}$', '$a_h$'),
  Description = c('leaf mass per area', 'leaf nitrogen content per dry mass', 'leaf phosphorous content per dry mass', 'wood specific gravity', 'diameter at breasth height threshold', 'asymptotic height', 'parameter of the tree-height-dbh allometry'),
  Units = c('$g.m^{-2}$', '$mg.g^{-1}$', '$mg.g^{-1}$', '$g.cm^{-3}$', '$m$', '$m$', '$m$')
)
knitr::kable(table, caption = 'Species-specific parameters used in TROLL from @Marechaux2017 Data originates from the BRIDGE [@Baraloto2010] and TRY [@Kattge2011] datasets.', format = 'pandoc')
```

A new disturbance module was developed for this study. In order to have a general overview of disturbance effect, we used untargeted disturbance happening only once to be free of confounding factors due to disturbance type specificity. At a given iteration $disturb_{iter}$, individual trees are randomly picked following a uniform law and without any individuals nor species targeting. Selected individuals are then removed without triggering a treefall to avoid any side effect. The operation is repeated until the cumulative basal area of removed trees reaches targeted threshold ($disturb_{intensity}$).

## Simulation experiment

In order to assess the role of biodiversity on ecosystem recovery from disturbance, we  simulated forest trajectories for different levels of disturbance intensity ($disturb_{intensity}$) and tree community compositions. For each simulation, we first simulated forest regeneration from bare soil for 600 years (pre-disturbance step), then simulated the disturbance described as above ($disturb_{iter}$), and finally let the simulated forest community freely recover from the disturbance during 600 years (post-disturbance step). Disturbance intensity, as quantified by the percentage of basal area loss ($disturb_{intensity}$), was fixed at 0% (control), 25%, 50% or 75%. For each level of disturbance, we performed 20 simulations differing in the original number of species (species richness, $SR=15,25,125$) and composition. We proceeded in two steps: (i) for each level of species richness, we created 1000 virtual communities by randomly picking the desired number of species among the regional species pool; (ii) among those 1000 communities, we selected 20 communities for simulations with a large range of convex hull volume $CVH$ [@Cornwell2006a] but with a community mean ($CM$) close to the one of the regional species pool ($CM_{LMA} = 115 \pm 19$, $CM_{wsg} = 0.73 \pm 0.07$, $CM_{dmax} = 0.37 \pm 0.1$, $CM_{hmax} = 40 \pm 11$) in order to get change in functional diversity and not in average functional composition. This led to 240 simulations varying in community composition and disturbance intensity ($3~SR*20~CHV*4~ levels~of~disturbance$). We focused on functional richness with convex hull volume $CVH$ and functional mean with community weighted mean $CWM$ to define simulation communities.

All simulations were made with a parameterization for an Amazonian forest of French Guiana, with 163 parameterized species, as in @Marechaux2017.

```{r, eval=F}
doe %>% 
  select(starts_with("CWM")) %>% 
  reshape2::melt() %>% 
  group_by(variable) %>% 
  summarise_all(funs(mean, sd, min, max))
```


## Analysis

### Quantifying simulated community diversity

Species and functional diversities were assessed for each simulation at the end of the pre-disturbance step with species richness ($SR$) and functional diversity indices [$FDiv$, the volume of the functional space occupied by the community, and $FEve$, the regularity of the distribution of abundance in this volume; @villeger_dynamique_2008] using the `FD` R package [@laliberte_distance-based_2010-1].

### Ecosystem recovery from disturbance

Simulated tropical forests were characterized in terms of changes in ecosystem properties regarding (i) forest structure (aboveground biomass ($AGB$ in $ton~C.ha^{-1}$), basal area ($BA$ in $m^2.ha^{-1}$), total number of stem ($N$), number of stem above $10~cm$ diameter ($N10$), and number of stem above $30~cm$ diameter ($N30$)) and (ii) forest functioning (growth primary productivity ($GPP$ in $MgC.ha^{-1}$), net primary productivity ($NPP$ in $MgC.ha^{-1}$), tree autotrophic day-time respiration ($Rday$ in $MgC.ha^{-1}$) and tree autotrophic night-time respiration ($Rnight$ in $MgC.ha^{-1}$)).

The recovery of the simulated forest at a time $t$, $R(t)$ regarding a given property $X$ was defined as follows (Figure \@ref(fig:IrGraphFinal)):

\begin{equation}
  R[X(t)] = \frac{X_D(t)}{X_C(t)}
  (\#eq:Recovery)
\end{equation}

where $X_D(t)$ and $X_C(t)$ are the values for the ecosystem property $X$ at time $t$ in the disturbed simulation ($disturb_{intensity} = 25\%, 50\%, 75\%$) and in the undisturbed control simulation ($disturb_{intensity} = 0\%$) respectively. Note that demographic stochasticity in the model induces a very low variability among replicated simulations with the same set-up so that we we assumed a given simulation is representative of the community properties and dynamics given an initial species pool and disturbance intensity [@Marechaux2017].

When $R(t)$ approaches $R_{eq}=1$, the disturbed and control systems are considered equivalent, indicating a perfect recovery. We then calculated the euclidean distance to this state of perfect recovery as $d_{eq}(t) = \sqrt{(R_{eq}-R(t))^2}$ (Figure \@ref(fig:IrGraphFinal)). Because the intensity of disturbance was set up by the user, our analysis did not include any ecosystem resistance, i.e. the ecosystem capacity to absorb a disturbance event. Consequently in this particular case, we used the inverse of cumulated euclidean distance to the equilibrium as an index of ecosystem resilience, further defined as $I_R$ (Figure \@ref(fig:IrGraphFinal)):

\begin{equation}
  I_R(X) = \frac 1 {\int _{t=disturb_{iter}} ^{t=disturb_{iter}+600} d_{eq}(t).dt}
  (\#eq:Resilience)
\end{equation}

A high value of $I_R$ indicates a fast resilience. Ecosystem euclidean distance to equilibrium and resilience index $I_R$ were calculated in a multi-dimensional space for the two set of ecosystem property values: (i) forest structure ($AGB$, $BA$, $N$, $N10$, and $N30$) and (ii) forest functioning ($GPP$, $NPP$, $Rday$, and $Rnight$). 

<!-- $$R[X(t)] = \frac{X_D(t)}{X_C(t)}$$ -->
<!-- $$d_{eq}(t) = \sqrt{(R_{eq}-R(t))^2}$$ -->
<!-- $$I_R(X) = \frac1{\int _{t=disturb_{iter}} ^{t=disturb_{iter}+600} d_{eq}(t).dt}$$ -->

```{r IrGraphFinal, fig.cap="Definition of recovery function R and resilience indice $I_R$ shown on aboveground biomass dynamics for a simulation with $disturb_{intensity}=50%$."}
knitr::include_graphics("images/figure3.png")
```

### Biodiversity effect

We tested the influence of pre-disturbance species richness ($SR$), functional evenness ($FEve$) and functional diversity ($FDiv$) on ecosystem resilience index $I_R$ for both forest structure and functioning using linear regression ($I_R \sim FEve + FDiv$). We tested variable correlation by Pearson's correlation coefficient for continuous variables and one-way ANOVA for species richness $SR$. In case of significant correlation, we selected the variable resulting in the model with the higher Aikaike information criterion in order to have independent variables. To meet the assumption of normality ecosystem resilience index $I_R$ was log-transformed.

For each ecosystem property $X$, we further investigated the effect of biodiversity and its variation along post-disturbance trajectories. The net effect of biodiversity ($NE$) on ecosystem property $X$ is defined as the difference between the ecosystem property $X$ of the simulated mixed-species community and the one expected under the null hypothesis that there is no effect of biodiversity, i.e. that ecosystem property $X$ for the mixed-species community equals the relative abundance-weighted sum of that in monoculture [@Loreau2001]. In order to do so, we made simulations for each of the 163 species in monoculture and for each level of disturbance leading to 652 simulations of monoculutre.

We then split this net biodiversity effect in complementarity and selection effect using @Loreau2001 partitioning:

\begin{equation}
  \begin{array}{c}
    NE = CE + SE \\
    CE = N* \overline{\Delta RX} \overline{M}\\
    SE = N*cov(\Delta RX,M)
  \end{array}
  (\#eq:BiodivPart)
\end{equation}

where $N$ represents the total number of species, and $M$ the vector of $X$ for the 163 simulations in monoculture and $\Delta RX$:

\begin{equation}
  \Delta RX_{sp} = \frac{X_{sp}(mixture)}{X_{sp}(monoculture)} - P_{sp}
  (\#eq:DeltaRY)
\end{equation}

where $X_{sp}$ is the ecosystem variable value for one species either in mixture $X_{sp}(mixture)$ or in monoculture $X_{sp}(monoculture)$. $P_{sp}$ is the proportion of the species in the mixture represented by species relative abundance. Similarly to recovery measurement, biodiversity net effect $NE$ can vary over time without disturbance. So in order to correctly assess selection and complementarity effect, we normalized it by ecosystem net effect $NE_C$ from the undisturbed control simulation ($disturb_{intensity} = 0\%$) to measure the recovery of the net biodiversity effect $R(NE)$:

\begin{equation}
  R(NE) = \frac{NE}{NE_C} = \frac{SE}{NE_C} + \frac{CE}{NE_C}
  (\#eq:RNE)
\end{equation}


# Results

## Biodiversity effect on forest resilience

```{r, eval=F}
doe %>% 
  select(SR, FDiv, FEve) %>% 
  reshape2::melt(id.vars = "SR") %>% 
  mutate(variable = paste0("$", variable, "$")) %>% 
  group_by(variable, SR) %>% 
  summarise(mean =  paste0("$", round(mean(value),2), 
                           "\\pm", round(sd(value),2), "$")) %>% 
  arrange(variable, desc(SR)) %>% 
  kable(caption = 'Mean and standard deviation of the predisturbance functional diversity indices for each level of species richness.',
        format = 'pandoc', col.names = c("Variable", "Species richness ($SR$)", 
                                         "Mean")) %>% 
  kable_styling(full_width = F)
```

Functional diversity ($FDiv$) and evenness ($FEve$) varied respectively from $0.76\pm0.18$ and $0.46\pm0.24$ to $0.96\pm0.02$ and $0.64\pm0.02$ with increasing species richness ($SR$) from 5 to 125 species. Species richness ($SR$) was significantly correlated to functional indices (one-way ANOVA $p-value < 0.001$ for both $FDiv$ and $FEve$) and model $AIC$ was higher without $SR$, consequently we used only functional indices for linear regressions. Both functional diversity ($FDiv$) and functional evenness ($FEve$) were positively related with $I_R$, i.e. they increased forest resilience (Figure \@ref(fig:gIr) and Table \@ref(tab:tgIr)). We found similar results for all disturbance levels, with increased significance for higher disturbance intensity.

```{r gIr, echo=FALSE, fig.cap='Variation of forest resilience with taxonomic and functional diversity for different levels of disturbance. Resilience indice $I_R$ was represented against functional diversity [FDiv, @villeger_new_2008] for different level of disturbance ($disturb_intensity$} = 25, 50 and 75% of total basal area); dot shapes varies with species richness whereas dot color indicates functional evenness [FEve, @villeger_new_2008]. Solid lines and grey areas show fitted relationships with their mean and variance of the form $I_R = FDiv + \\epsilon$.', fig.width=10, fig.height=15}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure, SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), value.name = "Ir") %>% 
  ggplot(aes(FDiv, Ir, shape = SR, col = FEve, group = NA)) +
  geom_smooth(method = 'lm', alpha = 0.3, colour= 'grey') +
  geom_point(size = 4) +
  facet_wrap(~disturbance, scales = "free", labeller = 'label_both', 
             nrow = 3) + 
  xlab('Functional diversity (FDiv)') +
  ylab('Resilience indice Ir') +
  scale_shape_discrete('Species\nrichness\n(SR)') +
  scale_color_continuous('Functional\nevenness\n(FEve)') +
  theme(text = element_text(size=20),
        legend.key.size=unit(4,"line"))
```

```{r tgIr, cache=T}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  mutate(SR = as.numeric(SR)) %>% 
  select(disturbance, structure, production,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), 
                 variable.name = "Ir") %>% 
  group_by(Ir, disturbance) %>%
  do(fit = lm(log(value) ~ FEve + FDiv, data = .)) %>% 
  # do(fit = lm(log(value) ~ FEve + FDiv, data = .)) %>% 
  tidy(fit) %>% 
  ungroup() %>% 
  filter(term != "(Intercept)") %>% 
  filter(!grepl("SR", term)) %>% 
  mutate(`P-value` = ifelse(p.value < 0.001, "***",
                            ifelse(p.value < 0.01, "**",
                                   ifelse(p.value < 0.05, "*",
                                          ifelse(p.value < 0.1, ".", 
                                                 "n.s."))))) %>% 
  mutate(Coefficient = round(estimate,2)) %>% 
  mutate(value = paste(Coefficient, `P-value`)) %>%
  mutate(value = cell_spec(value,
                           bold = ifelse(grepl("*", value,
                                               fixed = T), T, F))) %>%
  reshape2::dcast(Ir + disturbance ~ term, value.var = "value") %>% 
  left_join(Ir %>% 
              left_join(doe, by = "sim") %>% 
              ungroup() %>% 
              mutate(SR = as.factor(SR)) %>% 
              select(disturbance, structure, production,
                     SR, FEve, FDiv) %>% 
              reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), 
                             variable.name = "Ir") %>% 
              group_by(Ir, disturbance) %>%
              do(fit = lm(log(value) ~ FEve + FDiv, data = .)) %>% 
              glance(fit) %>% 
              mutate(r.squared = round(r.squared, 2)) %>% 
              select(Ir, disturbance, r.squared)) %>% 
  mutate(Ir = ifelse(Ir == "production", "functioning", "structure")) %>% 
  kable(caption = "Effects of functional diversity on forest resilience. Results of the linear regression testing the effect of functional diversity indices (FDiv and FEve) on the resilience index ($I_R$) for forest structure and functionning and for each level of disturbance intensity ($disturb_{intensity}$). To meet the assumption of normality $I_R$ was log-transformed. Test of FDiv and FEve effects was done by linear regression with FDiv and FEve as independant variables. Values of FDiv and FEve are coefficients from linear regressions. Significant $p-values$ are shown in bold. ns, non‐significant; . p < 0.1; * p < 0.05; ** p < 0.01; *** p < 0.001.",
        escape = F, col.names = c("$I_R$", "Disturbance intensity",
                                  "FDiv", "FEve", "$R^2$")) %>% 
  kable_styling(full_width = F) %>% 
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2)
```


```{r anova, eval=F}
tHSD <- doe %>% 
  ungroup() %>% 
  mutate(SR = as.factor(SR)) %>% 
  select(disturbance,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR")) %>% 
  group_by(variable) %>% 
  do(anova = aov(value ~ SR, data = .)) %>% 
  mutate(tHSD = TukeyHSD(anova, ordered = F, conf.level = 0.95)) %$%
  lapply(tHSD, function(x) multcompView::multcompLetters(x[,4])) %>% 
  lapply(function(x) data.frame(SR = names(x$Letters), group = x$Letters)) %>% 
  bind_rows() %>% 
  mutate(axis = c(rep("FEve", 3), rep("FDiv", 3)))
doe %>% 
  ungroup() %>% 
  mutate(SR = as.factor(SR)) %>% 
  select(disturbance,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR")) %>% 
  left_join(tHSD) %>% 
  ggplot(aes(SR, value, fill = SR, label = group)) +
  geom_boxplot() +
  geom_text(aes(y = 1.1)) +
  ggpubr::stat_compare_means(method = "anova", aes(label = paste("Anova", ..p.signif..))) +
  facet_wrap(~ variable, scales = "free") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

```{r residualsHist, eval=F}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  mutate(SR = as.factor(SR)) %>% 
  select(disturbance, structure, production,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), 
                 variable.name = "Ir") %>% 
  group_by(Ir, disturbance) %>%
  do(residuals = residuals(lm(log(value) ~ FEve + FDiv, data = .))) %>% 
  tidy(residuals) %>% 
  ggplot(aes(x)) +
  geom_histogram(bin = 20) +
  geom_vline(xintercept = 0, col = "red") +
  facet_grid(~ Ir + disturbance, scales = "free") +
  xlab("Residuals")
```

```{r residualsTest, eval=F}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  mutate(SR = as.factor(SR)) %>% 
  select(disturbance, structure, production,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), 
                 variable.name = "Ir") %>% 
  group_by(Ir, disturbance) %>%
  do(residuals = residuals(lm(log(value) ~ FEve + FDiv, data = .))) %>% 
  tidy(residuals) %>% 
  group_by(Ir, disturbance) %>% 
  do(normality = shapiro.test(.$x)) %>%
  tidy(normality) %>% 
  transmute(p.value = ifelse(p.value < 0.001, "***",
                             ifelse(p.value < 0.01, "**",
                                    ifelse(p.value < 0.05, "*",
                                           ifelse(p.value < 0.1, ".", 
                                                  "n.s.")))))
```

## Post-disturbance trajectories of biodiversity effect

```{r BE, echo=FALSE}
load(file.path(path, 'disturbanceBE.Rdata'))
load(file.path(path, 'disturbanceBErecovery.Rdata'))
```

The net effect of biodiversity on each ecosystem property was quantified and partitioned between selection and complementarity effects after normalizing using undisturbed control simulation ($disturb_{intensity}=0\%$, see Table \@ref(tab:tNE) and Figure \@ref(fig:gBE)). We found that complementarity effect sharply increased immediately after disturbance and was then the dominant effect of biodiversity during the first decades (Figure \@ref(fig:gBE)). Thereafter, the complementarity effect diminished toward a low value close to zero. On the contrary, selection effect sharply decreased right after disturbance. It then progressively increased to finally represent the majority of the net biodiversity effect about a century after disturbance. The dominance of complementarity effect was more important and lasted longer after disturbance with increasing disturbance intensity. Finally, 600 years after disturbance, the biodiversity net effect on aboveground biomass was still lower than the control for higher disturbance intensity (Figure \@ref(fig:gBE)). We found similar results but with an amplified signal for basal area ($BA$) and stem abundance ($N$). Finally, forest growth primary productivity ($GPP$) recovered only in few years with a dominant complementarity effect.

```{r tNE, echo=FALSE, cache=TRUE}
library(reshape2)
library(knitr)
BE %>%
  mutate(agb = agb/1000) %>% 
  filter(BE == 'NE') %>%
  melt(id.vars = c('BE', 'time', 'sim')) %>% 
  left_join(., doe, by = 'sim') %>%
  filter(SR == 125) %>%
  filter(disturbance == 0) %>%
  group_by(variable) %>% 
  summarise(mean = mean(value, na.rm = T), 
            sd = sd(value, na.rm = T)) %>% 
  filter(variable != 'n30') %>% 
  bind_cols(., data.frame(
    name = c('aboveground biomass', 'basal area', 'number of stems', 
             'number of stems above 10cm dbh', 'growth primary production', 
             'net primary production', 'autotrophic respiration during day',
             'autotrophic respiration during night'),
    unit = c('$tonC.ha^{-1}$', '$m^2.ha^{-1}$', '$n.ha^{-1}$', '$n.ha^{-1}$', 
             '$MgC.ha^{-1}$', '$MgC.ha^{-1}$', '$MgC.ha^{-1}$', '$MgC.ha^{-1}$'))) %>% 
  mutate(NE = paste0("$", round(mean,2), "\\pm", round(sd,2), "$")) %>% 
  select(name, NE, unit) %>% 
  kable(caption = 'Mean and standard deviation of the biodiversity net effect across mature simulations before the disturbance event (i.e. after 600 years of regeneration) for different ecosystem variables.',
        format = 'pandoc', col.names = c("Ecosystem property", "Net effect", "Unit")) %>% 
  kable_styling(full_width = F)
```

```{r gBE, echo=FALSE, fig.cap='Post-disturbance trajectories of complementarity and selection effects. The net biodiversity ($NE$), complementarity ($CE$) and selection ($SE$) effects were normalized by the net effect of biodiversity in the control simulation ($disturb_{intensity}=0%$). Solid lines represents the mean value whereas areas represents the range of values across the 20 simulations with a species richness ($SR$) of 125. Time axis has been square-root transformed to highlight first decades dynamic.'}
BEresilience %>% 
  left_join(., doe, by = 'sim') %>%
  filter(SR == 125) %>% 
  # filter(BE %in% c('SE', 'CE')) %>%
  group_by(time, BE, disturbance, SR) %>%
  summarise(qt1 =quantile(agb, probs=0.05),
            qt2 =quantile(agb, probs=0.75),
            mean=mean(agb),
            n=n()) %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 1, color = 'red') +
  geom_hline(yintercept = 0, color = 'blue') +
  geom_ribbon(aes(ymin = qt1, ymax = qt2, fill = BE), alpha = 0.3) +
  geom_line(aes(y = mean, color = BE)) +
  facet_grid(disturbance ~ SR, labeller = 'label_both') +
  xlab('Time (years)') +
  ylab('Post-disturbance trajectories of aboveground biomass net effect') +
  scale_x_sqrt() +
  theme(text = element_text(size=20),
        legend.key.size=unit(2,"line"))
```

# Discussion

We investigated the effect of biodiversity on tropical forest resilience to disturbance and the variation of biodiversity effect on ecosystem functioning along trajectory of recovery from disturbance by means of a virtual experiment. We found that functional diversity improved tropical forest resilience from disturbance. Additionally, the mechanisms that underlie the biodiversity effect on forest functioning changed in dominance as trajectories of recovery unfolded. Complememtarity between species was the dominant effect of biodiversity in the early times after disturbance. Complementarity was then progressively overtaken by a selection effect as more competitive species dominate the forest community. This shift was all the more pronounced that disturbance increased in intensity. Our results suggest that ecosystem state and past history can strongly influence the mechanisms by which biodiversity impacts ecosystem processes. This can help reconciling previous contrasted results obtained when dealing with snapshots of ecosystem state.

## Functional diversity improves tropical forest recovery

Our results validated the hypothesis of a significant positive relationship between forest recovery and functional diversity. More particularly, functional diversity [volume of the functional space occupied by the community, @villeger_new_2008] appeared as a major aspect of resilience if it is strengthened by a high functional evenness [regularity of the distribution of abundance in this volume, @villeger_new_2008]. Indeed, high functional diversity combined to high evenness avoid hegemonic effect of a few dominant species. Functional diversity positive effect on forest resilience can be due to (i) temporal complementarity with the diversity of species response to disturbances and response asynchronicity, resulting in ecological sorting [@Loreau2013; @Sakschewski2016; @Morin2014a], and (ii) functional complementarity reducing competition strength [@Loreau2013] advocating both for the biodiversity insurance hypothesis [@Yachi1999]. Our results thus confirms both the review of @Daz2001a, advocating against an under-evaluated importance of plant functional diversity in ecosystem processes, and @Zhang2012 who highlighted the role of evenness in productivity of forest ecosystems. In addition, increased species richness will de facto increase chance for high functional diversity through the sampling effect [@Loreau1998; @Morin2014a]. A higher sampling of regional species pool will thus allow a greater chance to pick more functionally diverse species.

## Mechanisms underlying the biodiveristy effect on forest ecosystem change along trajectories of recovery from disturbances

We found that complementarity among the species was the prevailing effect of biodiversity on forest functioning during the beginning of forest post-disturbance trajectory. We interpreted this result as the consequence of niche partitioning. By creating additional gaps in the simulated mature forest plots, the simulated disturbances resulted in an increased heterogeneity in the availability in light, which is the main limited resource in dense tropical forest. Species are known to vary widely in their growth response to gap creation depending on their functional strategy [@Herault2010; @Laurans2012; @Ruger2009]. Pioneer species with productive leaf tissue and light wood typically quickly close gaps, hence creating a shaded environment where late successional species with more conservative leaf tissue are more competitive. By promoting a higher diversity of shade tolerance and growth response to light, species richness hence foster forest response to small-scale perturbations [@Morin2011]. This complementarity effect quickly reduced through time letting the selection effect progressively gain in dominance. The diminishing of complementarity effect is attributed to the increased abundance of the most competitive species in more stable and less heterogeneous environment.

## Perspectives in forest ecosystem modelling

In this study we took advantage of a forest simulator able to jointly simulate biodiversity and ecosystem functioning to explore the effect of biodiversity on forest resilience on a long temporal scale, that remains out of reach of most experimental approaches. By virtually manipulating the number and identity of species across a large number of simulations, we were able to evidence the role of diversity in forest resilience and the changing driver of biodiversity effect on forest functioning along trajectory of recovery.

As any modelling approaches, it also comes with simplifications and assumptions. In our simulations, light was the unique resource whose variability was explicitly accounted for [@Marechaux2017]. Our results should thus be restricted to situations where aboveground competition for light overcomes the effect of belowground competition for water and nutrients, a reasonable assumption in humid tropical forests, even in early successional stages [@VanBreugel2012]. However this assumption may be less suitable under the predicted increase in drought intensity and frequency. We did not include the effect of topography, known to result in higher micro environmental heterogeneity. Overall, we expect a stronger role of complementarity effect through hydrological and edaphic niche partitioning as water become more limited and in more heterogeneous landscapes [@Baltzer2005; @Jucker2018; @Silvertown2004a]. Additionally, we simulated a generic form of disturbance, and our findings might be modulated depending on the disturbance specificity. For instance, selective logging will induce both species targeting which could lower the selection effect if dominant species are chosen and cyclic perturbation, increasing the prevalence of early recovery stages where complementarity effect plays the most. Consequently, we could hypothesize that species complementarity and functional diversity will be of primary importance regarding selective logging compared to less targeted disturbances with longer cycles such as drought, fires and hurricanes.

## Unifying biodiversity-ecosystem functioning studies

Our results suggest that the mechanisms through which biodiversity influence forest functioning strongly depends on the ecosystem state and its history of perturbation, with dominant complementarity effect in recently disturbed mature ecosystem whereas selection effect takes over complementarity in more stable systems with older disturbances. In agreement with this, studies in recently disturbed mature forest did found a stronger complementarity effect [@Huang2018; @Poorter2017], whereas a dominant selection effect has been found both in undisturbed forests our new plantations [@Bauters2015; @Finegan2015; @Marechaux2017; @Tobner2016] but see [@DeAvila2018; @Lohbeck2016].

Moreover, we here focus on the effect of biodiversity along trajectory of post-disturbance recovery, and our simulations and analyses were all made at a 16-ha scale. However, in addition to the influence of disturbance intensity and temporal trajectory we evidenced here, @Chisholm2013 and @Sullivan2017 found that biodiversity effect vary across spatial scale, with typically a stronger effect at smaller scale (e.g. 0.04-ha). Finally, ecological constraints may differ between ecosystems, for instance pioneer species (e.g. hard-wood pioneer species in dry forest [@Prado-Junior2016]), light importance (e.g. nitrogen importance in grasslands [@Fargione2007; @Prado-Junior2016]), and maturity concept (e.g. temperate versus tropical forests) can differ from tropical wet forest to another system, that may at the origin of biodiversity effects differences.

Together, this paves the way to a unifying framework to reconcile the apparent contradictions between studies advocating for the sole effect of complementarity or selection effects, and call for an accurate description of the ecosystem spatial-temporal and ecological context in future studies to improve global understanding of biodiversity and ecosystem functioning relations, and thus further open perspectives to a better prediction of ecosystem resilience in a context of increasing disturbances and biodiversity crisis.

```{r LiteratureBiodiversityEffect, eval=F}
literature <- data.frame(
  Study = c("@Bauters2015", "@Finegan2015", "@Prado-Junior2016",
            "@Lohbeck2016", "@DeAvila2018", "@Marechaux2017", "@Tobner2016",
            "@Morin2014a", "@Cardinale2007", "@VanderSande2017a",
            "@Poorter2017", "@Huang2018", "@Niklaus2017a",
            "@Fargione2007"),
  StudyType = c("Observation", "Observation", "Observation",
                "Observation", "Experiment", "Simulation", "Experiment",
                "Simulation", "Review", "Review",
                "Observation", "Experiment", "Experiment", 
                "Experiment"),
  Type = c("Forest", "Forest", "Forest", 
           "Forest", "Forest", "Forest", "Forest",
           "Forest", "Grasslands-Tundra-Estuaries", "Forest",
           "Forest", "Forest", "Forest", 
           "Grassland"),
  Biome = c("Tropical", "Tropical", "Tropical",
            "Tropical", "Tropical", "Tropical", "Temperate",
            "Temperate", "Temperate", "Tropical",
            "Tropical", "SubTropical", "SubToprical", 
            ""),
  SubBiome = c("Wet", "Wet-Dry", "Dry",
               "Wet?", "Wet", "Wet", "",
               "", "", "",
               "Wet", "", "", 
               ""),
  Effect = c("SE", "SE", "SE",
             "SE", "SE", "SE", "SE",
             "CE", "CE", "CE",
             "CE", "CE", "CE", 
             "SE-CE"),
  Disturbed = c("Y", "N?", "Y",
                "Y", "Y", "N", "Y",
                "N", "?", "?",
                "50%Y", "Y", "", 
                "Y"),
  Age = c("77yo", "", "12yo",
          "1-29yo", "21yo", "600yo", "8yo",
          "200yo", "", "",
          "14-32yo", "8yo", "18yo", 
          "10yo"),
  DisturbationType = c("Plantation", "", "Grazing/Logging",
                       "Secondary forest from fallow", "Logging-Thinning-Fire", "",
                       "Plantation",
                       "", "", "",
                       "Logging", "Plantation", "Plantation", 
                       "Plantation")
)
literature %>% 
  select(Effect, Disturbed, Age, DisturbationType, Study, 
         StudyType, Type, Biome, SubBiome) %>% 
  arrange(Effect,
          factor(Disturbed, levels = c("Y", "50%Y", "N", "N?", "?")),
          factor(Age, levels = c("8yo", "10yo", "12yo", "18yo", "1-29yo",
                                 "21yo", "14-32yo", "77yo", "200yo", "600yo", " "))) %>% 
  kable() %>% 
  kable_styling(full_width = F)
```


# Supplementary materials

* Supplementary materials S1: Leaf lifespan model
    + [HTML](S1-LL.html)
    + [PDF](S1-LL.pdf)
* Supplementary materials S2: Resilience index
    + [HTML](S2-Resilience.html)
    + [PDF](S2-Resilience.pdf)
* Supplementary materials S3: Biodiversity net effect and resilience 
    + [HTML](S3-RNE.html)
    + [PDF](S3-RNE.pdf)
* Supplementary materials S4: Linear models
    + [HTML](S4-LM.html)
    + [PDF](S4-LM.pdf)
* Supplementary materials S5: Biodiversity effect results
    + [HTML](S5-Biodiversity.html)
    + [PDF](S5-Biodiversity.pdf)
    
# References
