---
title: "Supplementary material S4: Linear models"
date: '`r Sys.Date()`'
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::pdf_document2:
    number_sections: false
    toc: false
  bookdown::word_document2: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()); invisible(gc())
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(broom)
theme_set(bayesplot::theme_default())
opts_chunk$set( echo = F, message = F, warning = F, 
                fig.height = 10, fig.width = 12,
                cache = T, cache.lazy = F)
```

```{r resilience, echo=FALSE}
rich <- c(5,25,125)
cvh <- 1:20
dist <- c(0,25,50,75)
path <- '~/Documents/ECOFOG/Results/disturbance/disturbance/data'
load(file.path(path, 'disturbanceDOE.Rdata'))
doe <- rename(doe, SR = richness)
load(file.path(path, 'disturbanceData.Rdata'))
load(file.path(path, 'disturbanceResilience.Rdata'))
```

```{r Deq, cache=TRUE, echo=FALSE}
Deq <- resilience %>% 
  group_by(time, sim) %>% 
  mutate_all(funs((1-.)^2)) %>% 
  mutate(structure = sqrt(sum(agb, ba, n, n10, n30))) %>% 
  mutate(production = sqrt(sum(gpp, npp, Rday, Rnight)))
```

```{r Ir, cache=TRUE, echo=FALSE}
Ir <- Deq %>% 
  group_by(sim) %>% 
  arrange(time) %>% 
  mutate_at(vars(-time, -sim), cumsum) %>% 
  filter(time == 600)
```

This supplementary material is here to check the validity of the linear model and to give additional ouptuts of the results not shown in the manuscript. It will be separated in four parts, (i) linear models, (ii) variables multicolinearity, (iii) validation of linear models, and (iv) results of linear models. 

# Linear models

We want to test the effect of diversity on the resilience indice $I_R$. For that we will test two models, one including only multi-trait diversity indices (model \@ref(eq:m1)) and one including single-trait diversity indices (model \@ref(eq:m2)):

\begin{equation}
    I_R = \beta_0 + \beta_{SR=5} + \beta_{SR=25} + \beta_{FDiv}*FDiv + beta_{FEve}*FEve + \epsilon \\
  (\#eq:m1)
\end{equation}

\begin{equation}
  \begin{split}
    I_R = \beta_0 + \beta_{SR=5} + \beta_{SR=25} + \beta_{FDiv}*FDiv + beta_{FEve}*FEve \\ 
    + beta_{FDis.LMA}*FDis.LMA beta_{FDis.wsg}*FDis.wsg \\
    + beta_{FDis.hmax}*FDis.hmax \epsilon
  \end{split}
  (\#eq:m2)
\end{equation}

The resilience indices is built either on multiple ecosystem variables as for forest structure (aboveground biomass ($AGB$ in $ton~C.ha^{-1}$), basal area ($BA$ in $m^2.ha^{-1}$), total number of stem ($N$), number of stem above $10~cm$ diameter ($N10$), and number of stem above $30~cm$ diameter ($N30$)) and for forest functioning (growth primary productivity ($GPP$ in $MgC.ha^{-1}$), net primary productivity ($NPP$ in $MgC.ha^{-1}$), tree autotrophic respiration in day ($Rday$ in $MgC.ha^{-1}$) and tree autotrophic respiration in night ($Rnight$ in $MgC.ha^{-1}$)), or for each variable independantly.

This results in two models multiplied by 11 $I_R$ indices giving 22 regressions.

# Variables multicolinearity

We tested multicolinearity for all independent variables of the two models, and none of theim have shown multicolinearity issues (all Pearson's and/or Spearman's correlation coefficients below 0.6, see figure \@ref(fig:multicolinearity)).

```{r multicolinearity, fig.cap="Pairs plot and multicolinearity between diversity indices. Subplots lower the diagonal shows scatterplots between continuous variables or boxplot when a discrete variable is implied. Subplots on the diagonal show density plot for continuous variables and barplot for discrete variables. Subplots upper the diagonal indicates the Pearson's correlation coefficient between variables."}
doe %>% 
  select(SR, FEve, FDiv, FDis.LMA, FDis.wsg, FDis.hmax) %>% 
  GGally::ggpairs()
```

# Models validation

We validated the 66 regressions with diagnostic plots (qqplot and Cook's leverage). Figures \@ref(fig:diag1Str), \@ref(fig:diag1Prod), \@ref(fig:diag2Str) and \@ref(fig:diag2Prod) shows relations between the $I_R$ indices computed for several ecosystem outputs, and diversity indices. Most of theim met the model assumptions requirements. Still $n$, $n10$ and $n30$ showed strong outliers for every level of disturbance in the two models. Those outliers echoed in the $structure$ variable only at a disturbance intensity of 75%. Similarly disturbance intensity of 75% included outliers for $production$, $gpp$, $npp$, $Rday$ and $Rnight$. Previously identified outliers corresponded to ecosystem simulations with only 5 species, which seemed to have derived toward an unexpected ecosystem state when strongly disturbed. Nevertheless those outliers should be taken into account in further interpretations.

## Multitrait

### Structure

```{r diag1Str, fig.cap="Effect of multi-trait diversity indices on resilience index $I_R$ for ecosystem variables linked to structure (AGB, BA, N, N10 and N30). To be completed with significativity and regression outputs when the final figure is chosen."}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure, agb, ba, n, n10, n30,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), value.name = "Ir") %>% 
  ggplot(aes(FDiv, Ir, shape = SR, col = FEve, group = NA)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(disturbance~variable, scales = "free_y", nrow = 3)
```

### Production

```{r diag1Prod, fig.cap="Effect of multi-trait diversity indices on resilience index $I_R$ for ecosystem variables linked to production (GPP, NPP, Rday, and Rnight)."}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         production, gpp, npp, Rday, Rnight,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), value.name = "Ir") %>% 
  ggplot(aes(FDiv, Ir, shape = SR, col = FEve, group = NA)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(disturbance~variable, scales = "free_y", nrow = 3)
```

## Monotrait

### Structure

#### FM

```{r diag3Str, fig.cap="Effect of mono-trait diversity indices on resilience index $I_R$ for structure ecosystem variables."}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure,
         CWM.LMA, CWM.wsg, CWM.hmax) %>% 
  reshape2::melt(id.vars = c("disturbance", "structure"), 
                 value.name = "CWM", variable.name = "Trait") %>% 
  ggplot(aes(CWM, structure, group = NA)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(disturbance~Trait, scales = "free", nrow = 3)
```

#### FD

```{r diag2Str, fig.cap="Effect of mono-trait diversity indices on resilience index $I_R$ for structure ecosystem variables."}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure,
         FDis.LMA, FDis.wsg, FDis.hmax) %>% 
  reshape2::melt(id.vars = c("disturbance", "structure"), 
                 value.name = "FDis", variable.name = "Trait") %>% 
  ggplot(aes(FDis, structure, group = NA)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(disturbance~Trait, scales = "free_y", nrow = 3)
```

### Production

#### FM

```{r diag3Prod, fig.cap="Effect of mono-trait diversity indices on resilience index $I_R$ for production ecosystem variables."}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         production,
         CWM.LMA, CWM.wsg, CWM.hmax) %>% 
  reshape2::melt(id.vars = c("disturbance", "production"), 
                 value.name = "CWM", variable.name = "Trait") %>% 
  ggplot(aes(CWM, production, group = NA)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(disturbance~Trait, scales = "free", nrow = 3)
```

#### FD

```{r diag2Prod, fig.cap="Effect of mono-trait diversity indices on resilience index $I_R$ for production ecosystem variables."}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         production,
         FDis.LMA, FDis.wsg, FDis.hmax) %>% 
  reshape2::melt(id.vars = c("disturbance", "production"), 
                 value.name = "FDis", variable.name = "Trait") %>% 
  ggplot(aes(FDis, production, group = NA)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(disturbance~Trait, scales = "free_y", nrow = 3)
```

# Models results

Tables \@ref(tab:fit1) and \@ref(tab:fit2) present the result of the 66 regressions for linear models \@ref(eq:m1) and \@ref(eq:m2).

## Multitrait only

Globally and as expected, $structure$ variables represented well $AGB$, $BA$, $N$ and $N10$ behavior, with a strong negative effect of functional diversity $FDiv$ on $I_r$ increasing with disturbance intensity and a significative effect of functional eveness $FEve$ only for the strongest distruabnce of 75%. $N30$ did not had any significant effect from diversity indices in multitrait. $SR25$ decreased $I_R$ for strong disturbance, only through its significative but low effect on $BA$.

Similarly, $production$ variable represented well $GPP$, $NPP$, $Rday$ and $Rnight$ behavior, with a significant effect of both functional diversity $FDiv$ and eveness $FEve$ on $I_r$ increasing with all disturbance levels (except $FDiv$ for a disturbance of 75%). $SR25$ decreased $I_R$ for strong disturbance, only through its significative but low effect on $NPP$.

```{r fit1}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure, agb, ba, n, n10, n30,
         production, gpp, npp, Rday, Rnight,
         SR, FEve, FDiv) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv"), value.name = "Ir") %>% 
  group_by(variable, disturbance) %>%
  do(fit = lm(Ir ~ SR + FEve + FDiv, data = .)) %>% 
  tidy(fit) %>% 
  ungroup() %>% 
  filter(term != "(Intercept)") %>% 
  mutate(`P-value` = ifelse(p.value < 0.001, "***",
                       ifelse(p.value < 0.01, "**",
                              ifelse(p.value < 0.05, "*",
                                     ifelse(p.value < 0.1, ".", "n.s."))))) %>% 
  mutate(Coefficient = round(estimate,2)) %>% 
  mutate(Recovery = variable) %>% 
  rename(Variable = term, `Disturbance intensity` = disturbance) %>%
  select(Recovery, `Disturbance intensity`, Variable, Coefficient, `P-value`) %>% 
  mutate(value = paste(Coefficient, `P-value`)) %>% 
    mutate(value = cell_spec(value, 
                           bold = ifelse(grepl("*", value, fixed = T), T, F))) %>%
  reshape2::dcast(Recovery + `Disturbance intensity` ~ Variable, value.var = "value") %>% 
  kable(caption = "Result of linear regression testing the effect of species richness and functional diversity indices on the recovery index by recovery type and disturbance intensity.", escape = F) %>% 
  kable_styling(full_width = F) %>% 
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2)
```

## Multi- and mono-trait

Globally mono-trait functional dispersion indices did not changed a lot the result due to absent or weak effects. Regarding $structure$, $FDis.hmax$ and $FDis.wsg$ had respectivelly significant small positive and negative effects on $BA$ and $N10$ but not on $structure$ itself, except for $FDis.wsg$ at low disturbance intensity (25%). On the opposite for $production$, $FDis.LMA$ had a significant positive effect increasing with disturbance intensity on $production$, $npp$, $Rday$ and $Rnight$. Increased dispersion in LMA traits thus tend to decrease ecosystem resilience of production variables.

```{r fit2}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure, agb, ba, n, n10, n30,
         production, gpp, npp, Rday, Rnight,
         SR, FEve, FDiv, FDis.LMA, FDis.wsg, FDis.hmax) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", "FEve", "FDiv", 
                             "FDis.LMA", "FDis.wsg", "FDis.hmax"), value.name = "Ir") %>% 
  group_by(variable, disturbance) %>%
  do(fit = lm(Ir ~ SR + FEve + FDiv + FDis.LMA + FDis.wsg + FDis.hmax, data = .)) %>% 
  tidy(fit) %>% 
  ungroup() %>% 
  filter(term != "(Intercept)") %>% 
  mutate(`P-value` = ifelse(p.value < 0.001, "***",
                       ifelse(p.value < 0.01, "**",
                              ifelse(p.value < 0.05, "*",
                                     ifelse(p.value < 0.1, ".", "n.s."))))) %>% 
  mutate(Coefficient = round(estimate,2)) %>% 
  mutate(Recovery = variable) %>% 
  rename(Variable = term, `Disturbance intensity` = disturbance) %>%
  select(Recovery, `Disturbance intensity`, Variable, Coefficient, `P-value`) %>%
  mutate(value = paste(Coefficient, `P-value`)) %>% 
  mutate(value = cell_spec(value, 
                           bold = ifelse(grepl("*", value, fixed = T), T, F))) %>%
  reshape2::dcast(Recovery + `Disturbance intensity` ~ Variable, value.var = "value") %>% 
  kable(caption = "Result of linear regression testing the effect of species richness and functional diversity indices on the recovery index by recovery type and disturbance intensity.", escape = F) %>% 
  kable_styling(full_width = F) %>% 
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2)
```

## Monotrait only

Adding $FM$  as the weighted sum of species traits = $CWM$.


```{r fit3}
Ir %>% 
  left_join(doe, by = "sim") %>% 
  ungroup() %>% 
  select(disturbance, 
         structure, agb, ba, n, n10, n30,
         production, gpp, npp, Rday, Rnight,
         SR, FDis.LMA, FDis.wsg, FDis.hmax,
         CWM.LMA, CWM.wsg, CWM.hmax) %>% 
  reshape2::melt(id.vars = c("disturbance", "SR", 
                             "FDis.LMA", "FDis.wsg", "FDis.hmax",
                             "CWM.LMA", "CWM.wsg", "CWM.hmax"), value.name = "Ir") %>% 
  group_by(variable, disturbance) %>%
  do(fit = lm(Ir ~ SR + CWM.LMA + CWM.wsg + CWM.hmax + FDis.LMA + FDis.wsg + FDis.hmax, data = .)) %>% 
  tidy(fit) %>% 
  ungroup() %>% 
  filter(term != "(Intercept)") %>% 
  mutate(`P-value` = ifelse(p.value < 0.001, "***",
                       ifelse(p.value < 0.01, "**",
                              ifelse(p.value < 0.05, "*",
                                     ifelse(p.value < 0.1, ".", "n.s."))))) %>% 
  mutate(Coefficient = round(estimate,2)) %>% 
  mutate(Recovery = variable) %>% 
  rename(Variable = term, `Disturbance intensity` = disturbance) %>%
  select(Recovery, `Disturbance intensity`, Variable, Coefficient, `P-value`) %>%
  mutate(value = paste(Coefficient, `P-value`)) %>% 
  mutate(value = cell_spec(value, 
                           bold = ifelse(grepl("*", value, fixed = T), T, F))) %>%
  reshape2::dcast(Recovery + `Disturbance intensity` ~ Variable, value.var = "value") %>% 
  kable(caption = "Result of linear regression testing the effect of species richness and functional diversity indices on the recovery index by recovery type and disturbance intensity.", escape = F) %>% 
  kable_styling(full_width = F) %>% 
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2)
```

# Conclusion

We developped here two linear models to explore the result of our simulations and more particularly the links between diversity indices and resilience of ecosystem variables. Our main issues is to summarize the global information of the 66 regressions in something more easy to assimilate for the reader.

First, I think that based on the hysteresis issue, the fact that ecosystem variables can reach equilibrium value in a transient state whithout reaching equilibirum, we can justify and use the aggregated variables $structure$ and $production$ to summarize all ecosystem variables. And I prefer to show and interpret those general ones, even if they are more abstrait, instead of picking one as an example.

Secondly, for $structure$ and $production$ variables models \@ref(eq:m1) and \@ref(eq:m2) gives similar results, at the exception of the effect of $FDis.LMA$ in $production$ resilience, meaning that in most of the case monotrait information is not useful. So I think we can keep only model \@ref(eq:m2) keeping in mind the effect of $FDis.LMA$ on $production$.

Consequently results can be summarized as follow. Functional diversity $FDiv$ have shown a significant strong negative effect increasing with disturbance intensity both on forest $structure$ and $production$. In addition, functional eveness $FEve$ have shown a significant strong negative effect increasing with disturbance intensity for forest $production$ and a significant negative effect on forest $structure$ only for the strongest level of disturbance (75%). Finally a species richness of 25 decreased the resilience indice of forest $structure$ and $production$ and $FDis.LMA$ have also shown a sinificant negative effect on forest $production$ only for model \@ref(eq:m2).
